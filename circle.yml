machine:
  node:
    version: 8.4.0
general:
  branches:
    ignore:
        - deploy-to-mock
        - deploy-to-preprod

dependencies:
    override:
        - yarn --frozen-lockfile
    cache_directories:
        - ~/.cache/yarn

test:
  override:
    - yarn run lint
    - yarn run snyk-protect
    - yarn run test-with-coverage -- --reporter mocha-junit-reporter:
        environment:
            MOCHA_FILE: $CIRCLE_TEST_REPORTS/test-results.xml
  post:
      - mkdir -p $CIRCLE_TEST_REPORTS/coverage/
      - find . -type f -regex ".*/coverage/**" -exec cp {} $CIRCLE_TEST_REPORTS/coverage/ \;

deployment:
  dev:
    branch: master
    commands:
        - yarn run build
        - yarn run record-build-info:
            environment:
                BUILD_NUMBER: $CIRCLE_BUILD_NUM
                GIT_REF: $CIRCLE_SHA1
        - git add --force --verbose assets/stylesheets build-info.json
        - git config user.name "Circle CI"
        - git config user.email "circle@circleci.com"
        - |
            CI_MESSAGE=$(git log --format=%B -n 1 $CIRCLE_SHA1)
            git commit -m "Deployment of build $CIRCLE_BUILD_NUM" -m "$CI_MESSAGE" -m "From gitref $CIRCLE_SHA1"
        # Push the Dev Branch to Azure
        - git push --force origin HEAD:deploy-to-mock



